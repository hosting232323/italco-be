stages:
  - test

variables:
  POSTGRES_DB: mydb
  POSTGRES_USER: myuser
  POSTGRES_PASSWORD: mypassword
  DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}

services:
  - name: postgres:15
    alias: postgres

before_script:
  - pip install -r requirements.txt
  - export DATABASE_URL=$DATABASE_URL

backend_test:
  stage: test
  script:
    # Attendi che Postgres sia pronto
    - until pg_isready -h postgres -U $POSTGRES_USER; do echo "Waiting for postgres..."; sleep 2; done
    # Esegui le migrazioni
    - alembic upgrade heads
    # Avvia il backend in background
    - python -m src &
    # Attendi qualche secondo per essere sicuri che il backend sia avviato
    - sleep 5
    # Esegui una richiesta curl alla rotta di base
    - curl -v http://localhost:8080/
