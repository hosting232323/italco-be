stages:
  - prepare
  - test

variables:
  POSTGRES_DB: mydb
  POSTGRES_USER: myuser
  POSTGRES_PASSWORD: mypassword
  DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
  DECODE_JWT_TOKEN: token
  GITLAB_PIPELINE: 'true'

# Job di preparazione FE (senza DinD)
prepare_fe:
  stage: prepare
  image: docker:latest
  script:
    - echo "ğŸ” Login al GitLab Registry..."
    - docker login -u "$CI_ITALCO_FE_USERNAME" -p "$CI_ITALCO_FE_TOKEN" registry.gitlab.com

    - echo "ğŸ“¦ Pull dell'immagine FE..."
    - docker pull registry.gitlab.com/generic-lab/italco/italco-fe:latest

    - echo "ğŸŒ Creo rete condivisa..."
    - docker network create testnet || true

    - echo "ğŸš€ Avvio container FE..."
    - docker run -d --name italco-fe --network testnet registry.gitlab.com/generic-lab/italco/italco-fe:latest

    - echo "âœ… FE avviato!"
  tags:
    - linux
  artifacts:
    expire_in: 1h
    paths:
      - fe_status.txt
  rules:
    - when: always
  # Mount del docker socket per usare il docker host
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock

# Job E2E
test_end_to_end:
  stage: test
  needs:
    - job: prepare_fe
      artifacts: true
  image: hosting23232323/python-node:3.11
  services:
    - name: postgres:15
      alias: postgres
    - name: selenium/standalone-chromium:latest
      alias: selenium
  script:
    - echo "ğŸ“¥ Installo curl..."
    - apk add --no-cache curl

    - echo "â³ Aspetto FE pronto..."
    - timeout 300 sh -c 'until docker run --rm --network testnet curlimages/curl:latest -s http://italco-fe:3000 > /dev/null; do echo "â³ Attendo FE..."; sleep 5; done'
    - echo "âœ… FE pronto!"

    - echo "ğŸ§ª Eseguo test Selenium..."
    # qui il tuo comando selenium, es: npm run e2e
  tags:
    - linux

# Lint Python/Backend
lint_backend:
  stage: test
  script:
    - pip install ruff
    - ruff check ./src --exit-non-zero-on-fix
    - ruff format ./src --exit-non-zero-on-fix
  tags:
    - linux
