stages:
  - prepare
  - test
  - lint
  - cleanup

image: hosting23232323/python-node:3.11-dockercli

variables:
  DOCKER_HOST: unix:///var/run/docker.sock
  DOCKER_TLS_CERTDIR: ""
  POSTGRES_DB: mydb
  POSTGRES_USER: myuser
  POSTGRES_PASSWORD: mypassword
  DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
  DECODE_JWT_TOKEN: token
  GITLAB_PIPELINE: 'true'

build_backend:
  stage: prepare
  script:
    - docker build -t italco-be:latest .
    - docker save italco-be:latest -o italco-be.tar
  artifacts:
    paths:
      - italco-be.tar
    expire_in: 1h
  tags:
    - linux

test_end_to_end:
  stage: test
  needs:
    - job: build_backend
      artifacts: true
  services:
    - name: selenium/standalone-chromium:latest
      alias: selenium
  before_script:
    - echo "üîê Login al GitLab Container Registry..."
    - docker login -u "$CI_DEPLOY_USER" -p "$CI_DEPLOY_TOKEN" registry.gitlab.com
  script:
    # Carico immagine backend
    - docker load -i italco-be.tar

    # Pulizia container e rete precedenti
    - docker rm -f italco-be italco-fe generic-test postgres || true
    - docker network rm testnet || true
    - docker network create testnet

    # Avvio PostgreSQL sulla rete testnet
    - docker run -d --name postgres --network testnet -e POSTGRES_DB=$POSTGRES_DB -e POSTGRES_USER=$POSTGRES_USER -e POSTGRES_PASSWORD=$POSTGRES_PASSWORD postgres:15

    # Aspetto Postgres
    - echo "‚è≥ Waiting for Postgres..."
    - |
      timeout=60
      until docker exec postgres pg_isready -U $POSTGRES_USER -d $POSTGRES_DB; do
        sleep 1
        ((timeout--))
        if [ $timeout -le 0 ]; then
          echo "‚ùå Postgres non √® pronto in tempo"
          docker logs postgres
          exit 1
        fi
      done

    # Migrazioni Alembic
    - docker run --rm --network testnet -e DATABASE_URL="$DATABASE_URL" -e OPENAI_API_KEY="test" -e ASSISTANT_ID="test" italco-be:latest alembic upgrade heads

    # Avvio backend e frontend sulla rete testnet
    - docker run -d --name italco-be --network testnet -e DATABASE_URL="$DATABASE_URL" -e OPENAI_API_KEY="test" -e ASSISTANT_ID="test" italco-be:latest
    - docker pull registry.gitlab.com/generic-lab/italco/italco-fe:latest
    - docker run -d --name italco-fe --network testnet registry.gitlab.com/generic-lab/italco/italco-fe:latest

    # Attendo Selenium (service GitLab)
    - echo "‚è≥ Waiting for Selenium..."
    - |
      timeout=120
      while ! curl -s http://selenium:4444/status | grep -q '"ready":true'; do
        sleep 1
        ((timeout--))
        if [ $timeout -le 0 ]; then
          echo "‚ùå Selenium non √® pronto in tempo"
          exit 1
        fi
      done

    # Eseguo test end-to-end dal container generic-test
    - docker pull registry.gitlab.com/generic-lab/generics/generic-test:latest
    - |
      docker run --rm \
        --network testnet \
        -e GITLAB_PIPELINE="true" \
        -e VITE_HOSTNAME_ITALCO_FE="http://italco-fe:3000" \
        registry.gitlab.com/generic-lab/generics/generic-test:latest \
        bash -c "pytest -s ./src/tests/italco/"

  artifacts:
    when: always
    paths:
      - generic-test/screenshots/
    expire_in: 1 week
  tags:
    - linux

lint_backend:
  stage: lint
  image: python:3.11
  script:
    - pip install ruff
    - ruff check ./src --exit-non-zero-on-fix
    - ruff format ./src --exit-non-zero-on-fix
  tags:
    - linux

cleanup:
  stage: cleanup
  image: docker:latest
  script:
    - docker stop italco-be italco-fe generic-test postgres || true
    - docker rm -f italco-be italco-fe generic-test postgres || true
    - docker network rm testnet || true
  when: always
  tags:
    - linux
