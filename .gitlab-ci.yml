stages:
  - prepare
  - test
  - lint
  - cleanup

image: hosting23232323/python-node:3.11-dockercli

variables:
  DOCKER_HOST: unix:///var/run/docker.sock
  POSTGRES_DB: mydb
  POSTGRES_USER: myuser
  POSTGRES_PASSWORD: mypassword
  DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
  DECODE_JWT_TOKEN: token
  GITLAB_PIPELINE: 'true'


build_backend:
  stage: prepare
  script:
    - docker build -t italco-be:latest .
    - docker save italco-be:latest -o italco-be.tar
  artifacts:
    paths:
      - italco-be.tar
    expire_in: 1h
  tags:
    - linux


test_end_to_end:
  stage: test
  needs:
    - job: be_dependencies
      artifacts: true
    - job: build_backend
      artifacts: true
  services:
    - name: docker:dind
      alias: docker
  before_script:
    - echo "üîê Login al GitLab Container Registry..."
    - docker login -u "$CI_ITALCO_FE_USERNAME" -p "$CI_ITALCO_FE_TOKEN" registry.gitlab.com
    - docker login -u "$CI_GENERIC_TEST_USERNAME" -p "$CI_GENERIC_TEST_TOKEN" registry.gitlab.com
  script:
    # Carico immagine backend
    - docker load -i italco-be.tar

    # Pulizia rete e container precedenti
    - docker rm -f italco-be italco-fe postgres selenium || true
    - docker network rm testnet || true
    - docker network create testnet

    # Avvio PostgreSQL
    - docker run -d --name postgres --network testnet -e POSTGRES_DB=$POSTGRES_DB -e POSTGRES_USER=$POSTGRES_USER -e POSTGRES_PASSWORD=$POSTGRES_PASSWORD postgres:15

    # Aspetto che Postgres sia disponibile
    - echo "‚è≥ Waiting for Postgres..."
    - until docker exec postgres pg_isready -U $POSTGRES_USER -d $POSTGRES_DB; do sleep 1; done

    # Eseguo le migrazioni Alembic
    - docker run --rm --network testnet -e DATABASE_URL="$DATABASE_URL" -e OPENAI_API_KEY="test" -e ASSISTANT_ID="test" italco-be:latest alembic upgrade heads

    # Avvio backend
    - docker run -d --name italco-be --network testnet -e DATABASE_URL="$DATABASE_URL" -e OPENAI_API_KEY="test" -e ASSISTANT_ID="test" italco-be:latest

    # Avvio frontend
    - docker pull registry.gitlab.com/generic-lab/italco/italco-fe:latest
    - docker run -d --name italco-fe --network testnet registry.gitlab.com/generic-lab/italco/italco-fe:latest

    # Avvio Selenium
    - docker run -d --name selenium --network testnet selenium/standalone-chromium:latest

    # Eseguo i test end-to-end
    - docker pull registry.gitlab.com/generic-lab/generics/generic-test:latest
    - docker run -d --name generic-test --network testnet registry.gitlab.com/generic-lab/generics/generic-test:latest bash -c "pytest -s ./src/tests/italco/"

  artifacts:
    when: always
    paths:
      - generic-test/screenshots/
    expire_in: 1 week
  tags:
    - linux


lint_backend:
  stage: lint
  image: python:3.11
  script:
    - pip install ruff
    - ruff check ./src --exit-non-zero-on-fix
    - ruff format ./src --exit-non-zero-on-fix
  tags:
    - linux


cleanup:
  stage: cleanup
  image: docker:latest
  script:
    - docker stop italco-be italco-fe postgres selenium || true
    - docker rm italco-be italco-fe postgres selenium || true
    - docker network rm testnet || true
  when: always
  tags:
    - linux
