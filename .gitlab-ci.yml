image: python:3.10

stages:
  - test

run_selenium_tests:
  stage: test
  variables:
    GIT_STRATEGY: fetch
  before_script:
    - apt-get update && apt-get install -y wget unzip curl gnupg git npm

    # Installa Google Chrome stabile
    - wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
    - apt install -y ./google-chrome-stable_current_amd64.deb

    # Installa ChromeDriver compatibile con Chrome installato
    - |
      CHROME_VERSION=$(google-chrome --version | grep -oP '\d+\.\d+\.\d+' | head -1)
      echo "üîß Chrome version: $CHROME_VERSION"
      CHROME_DRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_VERSION")
      echo "üîß ChromeDriver version: $CHROME_DRIVER_VERSION"
      wget -q -O /tmp/chromedriver.zip "https://chromedriver.storage.googleapis.com/${CHROME_DRIVER_VERSION}/chromedriver_linux64.zip"
      unzip /tmp/chromedriver.zip -d /usr/local/bin/
      chmod +x /usr/local/bin/chromedriver


    # Avvia il BE
    - pip install -r requirements.txt
    - export DATABASE_URL=postgresql://neondb_owner:npg_lsyKXoUk26Dx@ep-morning-sea-af7jtbs5.c-2.us-west-2.aws.neon.tech/neondb?sslmode=require
    - export DECODE_JWT_TOKEN='blablabla'
    - python -m src &
    - |
      until curl -s http://127.0.0.1:8080 > /dev/null; do
        echo "‚è≥ Aspetto che il BE parta su 127.0.0.1:8080..."
        sleep 2
      done

    # Clona il frontend
    - git clone -b new-pytest https://$CI_FE_USERNAME:$CI_FE_TOKEN@gitlab.com/generic-lab/italco/italco-fe.git frontend

    # Installa FE e avvia in produzione
    - cd frontend
    - npm install
    - export VITE_HOSTNAME=http://127.0.0.1:8080
    - npm run build || exit 1
    - npm run serve &
    - cd ..

    # Attende che il frontend risponda
    - |
      until curl -s http://localhost:3000 > /dev/null; do
        echo "‚è≥ Aspetto che il FE parta su localhost:3000..."
        sleep 2
      done

    # Clona i test
    - git clone -b italco-test https://$CI_GENERIC_TEST_USERNAME:$CI_GENERIC_TEST_TOKEN@gitlab.com/generic-lab/generics/generic-test.git generic-test
    - cd generic-test
    - pip install -r ./requirements.txt

  script:
    - export VITE_HOSTNAME_ITALCO_FE=http://localhost:3000
    - pytest -s ./tests/italco/test_login.py
  only:
    - branches
 