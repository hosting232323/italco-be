stages:
  - test

image: hosting23232323/python-node:3.11

variables:
  POSTGRES_DB: mydb
  POSTGRES_USER: myuser
  POSTGRES_PASSWORD: mypassword
  DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
  DECODE_JWT_TOKEN: token
  GITLAB_PIPELINE: 'true'

test_end_to_end:
  stage: test
  services:
    - name: postgres:15
      alias: postgres
    - name: selenium/standalone-chromium:latest
      alias: selenium
    - name: registry.gitlab.com/generic-lab/italco/italco-fe:latest
      alias: italco-fe
  script:
    - echo "üì• Installo curl..."
    - apk add --no-cache curl

    - echo "‚è≥ Aspetto che il FE sia pronto (max 5 minuti)..."
    - timeout 300 sh -c 'until curl -s http://italco-fe:3000 > /dev/null; do echo "‚è≥ Attendo FE..."; sleep 5; done'
    - echo "‚úÖ FE pronto!"

  tags:
    - linux

lint_backend:
  stage: test
  script:
    - pip install ruff
    - ruff check ./src --exit-non-zero-on-fix
    - ruff format ./src --exit-non-zero-on-fix
  tags:
    - linux
