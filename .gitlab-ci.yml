stages:
  - prepare
  - build
  - lint
  - test
  - cleanup

image: hosting23232323/python-node:3.11

variables:
  POSTGRES_DB: mydb
  POSTGRES_USER: myuser
  POSTGRES_PASSWORD: mypassword
  DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
  DECODE_JWT_TOKEN: token
  GITLAB_PIPELINE: 'true'

# ------------------------------
# PREPARE STAGE
# ------------------------------
be_dependencies:
  stage: prepare
  script:
    - git clone https://$CI_GENERIC_TEST_USERNAME:$CI_GENERIC_TEST_TOKEN@gitlab.com/generic-lab/generics/generic-test.git
    - cd generic-test
    - pip install -r ./requirements.txt
  artifacts:
    paths:
      - generic-test
      - venv
    expire_in: 1h
  tags:
    - linux

# ------------------------------
# BUILD STAGE
# ------------------------------
build_backend:
  stage: build
  image: docker:latest
  variables:
    DOCKER_HOST: unix:///var/run/docker.sock
  script:
    - docker build -t italco-be:latest .
    - docker save italco-be:latest -o italco-be.tar
  artifacts:
    paths:
      - italco-be.tar
    expire_in: 1h
  tags:
    - linux

# ------------------------------
# LINT STAGE
# ------------------------------
lint_backend:
  stage: lint
  image: python:3.11
  script:
    - pip install ruff
    - ruff check ./src --exit-non-zero-on-fix
    - ruff format ./src --exit-non-zero-on-fix
  tags:
    - linux

# ------------------------------
# TEST STAGE
# ------------------------------
test_end_to_end:
  stage: test
  services:
    - name: postgres:15
      alias: postgres
    - name: selenium/standalone-chromium:latest
      alias: selenium
  image: docker:latest
  variables:
    DOCKER_HOST: unix:///var/run/docker.sock
  before_script:
    - echo "üîê Login al GitLab Container Registry..."
    - docker login -u "$CI_ITALCO_FE_USERNAME" -p "$CI_ITALCO_FE_TOKEN" registry.gitlab.com
  script:
    - docker load -i italco-be.tar
    - docker rm -f italco-be italco-fe || true
    - docker network rm testnet || true

    - docker network create testnet

    # Alembic migration
    - docker run --rm italco-be:latest alembic upgrade heads

    # Run containers
    - docker run -d --name italco-be --network testnet -e DATABASE_URL=$DATABASE_URL -e OPENAI_API_KEY='test' italco-be:latest
    - docker pull registry.gitlab.com/generic-lab/italco/italco-fe:latest
    - docker run -d --name italco-fe --network testnet registry.gitlab.com/generic-lab/italco/italco-fe:latest

    # Run tests
    - cd generic-test
    - export VITE_HOSTNAME="http://italco-be:8080/"
    - export VITE_HOSTNAME_ITALCO_FE="http://italco-fe:3000/"
    - pytest -s ./src/tests/italco/test_login.py
  dependencies:
    - be_dependencies
    - build_backend
  tags:
    - linux

# ------------------------------
# CLEANUP STAGE (optional)
# ------------------------------
cleanup:
  stage: cleanup
  image: docker:latest
  script:
    - docker stop italco-be italco-fe || true
    - docker rm italco-be italco-fe || true
    - docker network rm testnet || true
  when: always
  tags:
    - linux
